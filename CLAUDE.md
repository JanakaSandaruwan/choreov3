# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

OpenChoreo is an open-source Internal Developer Platform (IDP) that provides Kubernetes-native abstractions for
developers and platform engineers.
It implements a multi-plane architecture with control plane, and data plane separation using custom Kubernetes CRDs.
This project is still in early development stages, and not suitable for production use yet.

## Architecture Overview

### Multi-Plane Architecture

OpenChoreo implements a multi-plane architecture that separates concerns across different operational domains:

- **Control Plane**: Hosts OpenChoreo controllers, manages developer intent, and orchestrates resources
- **Data Plane**: Kubernetes clusters where the actual workloads run, managed by the control plane
- **Build Plane**: Handles continuous integration with Argo Workflows for building container images
- **Observability Plane**: Provides monitoring and logging capabilities using OpenSearch and the Observer API

### Design Principles

OpenChoreo follows core architectural patterns that separate developer abstractions from platform engineer governance:

- **Claim/Class Pattern**: Platform Engineers define Classes (templates/governance), Developers create Claims (intent)
- **Workload as Source Code Definition**: Workload is a special resource that defines the source code for certain
  component types. It defines containers, configurations, endpoints and connections.
- **Environment Independence**: Developer intent resources (Component, Workload, API, Service, ScheduledTask,
  WebApplication) are not bound to specific environments
- **Environment-Bound Bindings**: Binding resources (ServiceBinding, ScheduledTaskBinding, WebApplicationBinding,
  APIBinding) are environment-specific copies of component type resources (Service, ScheduledTask, WebApplication, API)
  that include both the component's type-specific configurations and its associated workload specification. Each binding
  references a specific environment via an `environmentName` field and can be created by users during promotion to
  higher environments
- **Releases**: A single Release resource contains the final Kubernetes manifests generated by Binding
  controllers and are deployed to data plane clusters.
- **Multi-Plane Separation**: Control plane manages intent and orchestration, data planes run workloads, build plane handles CI/CD, observability plane provides monitoring

### Domain Model

```
OpenChoreo Platform
└── Organization (just a K8s namespace) - Many organizations
    ├── ServiceClass (PE-defined templates to govern services)
    ├── ScheduledTaskClass (PE-defined templates to govern scheduled tasks)
    ├── WebApplicationClass (PE-defined templates to govern web applications)
    ├── APIClass (PE-defined templates to govern APIs)
    ├── Project - Many per organization (references DeploymentPipeline)
    │   └── Component - Many per project
    │       ├── Workload (describes source code with configurations, endpoints and connections)
    │       ├── DeploymentTrack - Many per component (Optional - Git branch alignment)
    │       ├── Service (References Component's Workload & Organization's ServiceClass)
    │       ├── ServiceBinding
    │       ├── ScheduledTask (References Component's Workload & Organization's ScheduledTaskClass)
    │       ├── ScheduledTaskBinding
    │       ├── WebApplication (References Component's Workload & Organization's WebApplicationClass)
    │       ├── WebApplicationBinding
    │       ├── API (References Organization's APIClass)
    │       ├── APIBinding
    │       └── Release (Release resource for all component types that contains final manifests deployed to data plane)
    ├── DeploymentPipeline - Many per organization (defines promotion order between environments)
    ├── Environment - Many per organization (References DataPlane)
    ├── DataPlane - Many per organization
    └── GitCommitRequest - Many per organization (Optional - GitOps automation)
```

**Key Relationships:**

- **One Organization → Many Project**: Each organization (K8s namespace) contains multiple projects
- **One Organization → Many Class**: Each organization contains Platform Engineer-defined Class templates
- **One Organization → Many Environment**: Each organization can have multiple environments (dev, staging, prod)
- **One Organization → Many DataPlane**: Each organization can have multiple DataPlane clusters
- **One Organization → Many DeploymentPipeline**: Each organization can define multiple deployment pipelines to enforce
  promotion order between environments
- **One Project → One DeploymentPipeline**: Each project references a deployment pipeline that defines the promotion
  order for its components
- **One Environment → One DataPlane**: Each environment references a specific DataPlane for deployment
- **One Project → Many Component**: Each project contains multiple Component resources
- **One Component → One Type**: Each Component has exactly one type (Service, ScheduledTask, WebApplication, etc.)
- **One Component → Zero or One Workload**: Each Component may have zero or exactly one Workload (pure data structure)
- **One Component → Many DeploymentTrack**: Each Component can have multiple DeploymentTracks (optional for Git branch
  alignment)
- **Runtime Component Types → Reference Workload**: Service, ScheduledTask, and WebApplication reference their
  Component's Workload
- **All Component Types → Reference Organization Classes**: All component types reference their Organization's Class
  templates
- **Bindings → Copy Workload & Reference Classes**: Bindings contain a copy of the workload spec but still reference
  Classes for governance
- **Component-Type-Specific Controllers**: Each type has its own controller, class, and binding resources
- **Release Controller**: Release controller handles deployment for all component types to the data plane, providing
  consistent resource tracking, stale resource cleanup, and lifecycle management across Services, ScheduledTasks,
  WebApplications, and APIs
- **Claim/Class Pattern**: Developers create Claims (component types), Platform Engineers define Classes (governance)
- **Binding Pattern**: Environment-bound copies for progressive delivery
- **Release Pattern**: Created by Binding controllers, contain final K8s manifests sent to data plane

## Project Structure

### Directory Layout

```
├── api/v1alpha1/                           # Kubernetes CRD type definitions
├── cmd/                                    # Application entry points
│   ├── main.go                             # Controller manager main
│   ├── choreoctl/                          # CLI tool
│   ├── observer/                           # Observer API server
│   └── openchoreo-api/                     # OpenChoreo API server
├── config/                                 # Kubernetes manifests and configurations
│   ├── crd/bases/                          # Generated CRD YAML files
│   ├── rbac/                               # RBAC configurations
│   ├── samples/                            # Sample CRD instances
│   └── manager/                            # Controller manager deployment
├── internal/controller/                    # Controller implementations
│   ├── component/                          # Component controller
│   ├── workload/                           # Workload controller
│   ├── api/                                # API controller
│   ├── apiclass/                           # APIClass controller
│   ├── apibinding/                         # APIBinding controller
│   ├── build/                              # Build controller (Argo Workflows integration)
│   ├── buildplane/                         # BuildPlane controller
│   ├── endpoint/                           # DEPRECATED - Legacy endpoint controller
│   ├── scheduledtask/                      # ScheduledTask controller
│   ├── scheduledtaskclass/                 # ScheduledTaskClass controller
│   ├── scheduledtaskbinding/               # ScheduledTaskBinding controller
│   ├── service/                            # Service controller
│   ├── serviceclass/                       # ServiceClass controller
│   ├── servicebinding/                     # ServiceBinding controller
│   ├── webapplication/                     # WebApplication controller
│   ├── webapplicationclass/                # WebApplicationClass controller
│   ├── webapplicationbinding/              # WebApplicationBinding controller
│   ├── release/                            # Release controller
│   ├── deployment/                         # DEPRECATED - Legacy deployment controller
│   ├── deployableartifact/                 # DEPRECATED - Legacy deployable artifact controller
│   ├── deploymentpipeline/                 # DeploymentPipeline controller
│   ├── deploymenttrack/                    # DeploymentTrack controller
│   ├── dataplane/                          # DataPlane controller
│   ├── environment/                        # Environment controller
│   ├── organization/                       # Organization controller
│   ├── project/                            # Project controller
│   └── gitcommitrequest/                   # GitOps automation controller
├── internal/dataplane/                     # Data plane integration utilities
├── pkg/cli/                                # CLI package containing choreoctl implementation
├── docs/                                   # Project documentation
├── samples/                                # Real-world usage examples
└── install/                                # Installation scripts and Helm charts
    └── helm/                               # Helm charts directory
        ├── cilium/                         # Cilium CNI for network policies
        ├── openchoreo-build-plane/         # Build plane Helm chart (Argo Workflows)
        ├── openchoreo-control-plane/       # Control plane Helm chart
        ├── openchoreo-data-plane/          # Data plane Helm chart
        ├── openchoreo-identity-provider/   # Identity provider components
        └── openchoreo-observability-plane/ # Observability stack (OpenSearch, Observer)
```

### Core Components

- **Controller Manager (`cmd/main.go`)**: Main Kubernetes controller with CRD reconcilers that run in the control plane
- **CLI (`cmd/choreoctl/`)**: User-facing command-line (`choreoctl`) tool
- **Observer (`cmd/observer/`)**: REST API server for the Observability plane abstracting the OpenSearch API
- **OpenChoreo API (`cmd/openchoreo-api/`)**: REST API server providing programmatic access to OpenChoreo resources for Backstage plugins and other integrations

### Controller Manager

- **CRD Types**: Kubernetes CRD Go types are defined in `api/v1alpha1/<singular-crd-name>_types.go`
- **Controller Logic**: Each controller logic will reside in `internal/controller/<singular-crd-name>/` package

## Essential Commands

For comprehensive development guides, see docs/contributors/README.md or run `make help` for all available commands.

### Linting and Formatting

- `make lint` - Run golangci-lint linter
- `make lint-fix` - Run linter with automatic fixes

### Code Generation

- `make code.gen` - Generate all code (manifests, deepcopy, lint fixes)
- `make code.gen-check` - Verify no uncommitted changes after generation
- `make generate manifests` - Generate DeepCopy methods, CRDs, RBAC, and webhook configurations

### Building

- `make go.build` - Build all binaries (manager, choreoctl) for current platform
- `make go.build.manager` - Build controller manager only

## Deprecated CRDs

The following CRDs are **deprecated** and should not be used for new development. While some still have active
controllers for backward compatibility, they represent old architecture patterns:

### Legacy/Deprecated CRDs:

- **ConfigurationGroup** - Legacy configuration pattern (no controller implementation)
- **DeployableArtifact** - Legacy deployment pattern (has controller but deprecated)
- **Deployment** - Legacy deployment pattern (has extensive controller implementation but deprecated)
- **Endpoint** - Replaced by workload endpoints (has controller but deprecated in favor of API design)

**Note**: These deprecated CRDs may still have:
- Active controller implementations for backward compatibility
- Sample files in config/samples/
- References in the codebase

However, they represent old architecture patterns that have been replaced by the current
Claim/Class/Binding/Release pattern and should NOT be used as reference for new CRDs.

## Development Environment

### Tools Available

- **Go**: Version 1.24.2 (via gvm)
- **Node.js**: Version 20.16.0 (via nvm)
- **Docker**: Version 27.1.2 with docker-compose
- **Cloud Tools**: Azure CLI, Terraform 1.11.3
- **Kubernetes Tools**: 
  - `kubectl` - Kubernetes CLI (available via Homebrew)
  - `helm` - Kubernetes package manager (available via Homebrew)
  - `k9s` - Kubernetes TUI for cluster management (available via Homebrew)
  - `kind` - Create local Kubernetes clusters for development and testing (available via Homebrew)
  - `kubebuilder` - Kubernetes operator framework (available via Homebrew)
- **Productivity Tools**: 
  - `rg` (ripgrep) - Use instead of `grep` for fast searching
  - `fd` - Fast find alternative
  - `jq` - JSON processor
  - `yq` - YAML processor
  - `gh` - GitHub CLI for repository operations
  - `bat` - cat with syntax highlighting
  - `eza` - modern ls replacement

### Search Tools

- **Use `rg` instead of `grep`** - ripgrep is available and much faster
- **Use `fd` instead of `find`** - faster file finding
- **Use `jq` for JSON processing** - available for parsing JSON files
- **Use `yq` for YAML processing** - available for parsing YAML files

### File Operations

- **Check for trailing newlines**: Use `find <directory> -name "*.yaml" -o -name "*.tpl" | while read file; do if [ ! -s "$file" ] || [ "$(tail -c1 "$file")" != "" ]; then echo "MISSING NEWLINE: $file"; fi; done` to verify files end with newlines
- **Add trailing newlines**: Use `find <directory> -name "*.yaml" -o -name "*.tpl" | while read file; do if [ ! -s "$file" ] || [ "$(tail -c1 "$file")" != "" ]; then echo "" >> "$file"; fi; done` to add missing newlines

## Related Repositories

The OpenChoreo project includes additional repositories alongside the main codebase:

- **`../backstage-plugins/`**: Contains Backstage plugins for OpenChoreo integration and a demo Backstage UI for showcasing the platform's capabilities
- **`../openchoreo.github.io/`**: Contains the GitHub Pages documentation website for the project

## GitHub Operations
- **Operations**: Use the `gh` CLI for GitHub operations like creating/viewing issues, pull requests, and managing repositories
- **Issue Branching**: Use `git checkout -b issue-<issue-number> upstream/main` to create a new branch for working on GitHub issues
- **Issue Creation**: Use `gh issue create` to create new issues according to the project's issue templates
- **Pull Requests**: Use `gh pr create` to create pull requests, following the project's PR templates

## Important Notes

- **CRD Updates**: Always run `make manifests generate install` after modifying API types in `api/v1alpha1/`
- **Controller Patterns**: The project follows standard Kubernetes controller patterns and conventions
- **File Endings**: All files must end with a newline character. When creating new files, ensure they end with a proper newline
- **Search Optimization**: Use `rg` instead of `grep` for faster code searches
- **GitHub Operations**: Use `gh` CLI for GitHub-related operations (PRs, issues, etc.)
- **Task Tracking**: Use TASKS.md for task management and tracking
